#!/bin/bash

# Get the target branch name.
while read local_ref local_sha remote_ref remote_sha; do
    if [[ -n "$remote_ref" ]]; then
        branch_name=${remote_ref#refs/heads/}

        # Protect branches.
        if [[ $branch_name =~ ^(main|dev)$ ]]; then
            echo "‚ùå Error: You are not allowed to push a local branch to 'origin/$branch_name'!"
            exit 1
        fi

        # Check branch name prefix.
        if ! [[ $branch_name =~ ^(feature/|refactor/|bugfix/|release/|docs/).+ ]]; then
            echo "‚ùå Error: Branch name '$branch_name' doesn't follow naming convention!"
            echo "üí° Branch name must start with one of: feature/, refactor/, bugfix/, release/, docs/."
            exit 1
        fi

        # Check branch name format: only letters, numbers and hyphens allowed.
        if ! [[ $branch_name =~ ^[a-zA-Z0-9/-]+$ ]]; then
            echo "‚ùå Error: Branch name '$branch_name' contains invalid characters!"
            echo "üí° Branch name can only contain letters (a-zA-Z), numbers (0-9) and hyphens (-)."
            echo "   No spaces, underscores or other special characters allowed."
            exit 1
        fi

        # Check hyphen usage rules.
        if [[ $branch_name =~ ^-|-$ ]] || [[ $branch_name =~ -- ]]; then
            echo "‚ùå Error: Branch name '$branch_name' has incorrect hyphen usage!"
            echo "üí° Branch name cannot start/end with hyphen or contain consecutive hyphens (--)."
            exit 1
        fi
    fi
done

# Run unit tests.
echo "üö¶ Running unit tests..."
uv run pytest
if [ $? -ne 0 ]; then
    echo "‚ùå Unit tests failed. Please fix the tests before pushing."
    exit 1
fi

exit 0