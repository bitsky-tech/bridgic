#!/bin/bash

# Check branch naming convention.
while read oldrev newrev refname; do
    if [[ $refname =~ refs/heads/ ]]; then
        branch_name=${refname#refs/heads/}

        # Protect branches.
        if [[ $branch_name =~ ^(main|dev)$ ]]; then
            echo "‚ùå Error: It is not allowed to push a local branch to 'origin/$branch_name'!"
            exit 1
        fi

        # Check branch name prefix.
        if ! [[ $branch_name =~ ^(feature/|refactor/|bugfix/|release/|docs/).+ ]]; then
            echo "‚ùå Error: Branch name '$branch_name' doesn't follow naming convention!"
            echo "üí° Branch name must start with one of: feature/, refactor/, bugfix/, release/, docs/."
            exit 1
        fi

        # Check branch name format: only letters, numbers and hyphens allowed.
        if ! [[ $branch_name =~ ^[a-zA-Z0-9/-]+$ ]]; then
            echo "‚ùå Error: Branch name '$branch_name' contains invalid characters!"
            echo "üí° Branch name can only contain letters (a-zA-Z), numbers (0-9) and hyphens (-)."
            echo "   No spaces, underscores or other special characters allowed."
            exit 1
        fi

        # Check hyphen usage rules.
        if [[ $branch_name =~ ^-|-$ ]] || [[ $branch_name =~ -- ]]; then
            echo "‚ùå Error: Branch name '$branch_name' has incorrect hyphen usage!"
            echo "üí° Branch name cannot start/end with hyphen or contain consecutive hyphens (--)."
            exit 1
        fi
    fi
done
